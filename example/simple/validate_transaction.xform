// ============================================================================
// FILE: validate_transaction.xform
// LAYER: L3 - Transform Definition
// USE CASE: Simple Transaction Validation
// ============================================================================
//
// SUMMARY:
// This transform file defines data transformation logic for credit card
// transaction validation. It contains two transforms:
//
// 1. validate_basic - The main validation transform that:
//    - Validates input data (amount positive, required fields present)
//    - Checks card expiration against current date
//    - Enforces transaction amount limits ($10,000 max)
//    - Outputs validated transaction with is_valid flag and error list
//
// 2. mask_card_number - A utility transform that masks card numbers for
//    secure logging, showing only last 4 digits (****-****-****-1234)
//
// TRANSFORMS ARE PURE: They have no side effects, same input always produces
// same output, making them testable and parallelizable.
// ============================================================================

// ----------------------------------------------------------------------------
// TRANSFORM: validate_basic
// PURPOSE: Validate incoming transactions and check card expiry/amount limits
// INPUT: card_transaction (raw transaction)
// OUTPUT: validated_transaction (with is_valid flag and errors)
// ----------------------------------------------------------------------------
transform validate_basic                         // Declare transform named 'validate_basic'
    version: 1.0.0                               // Transform version for tracking changes
    description: "Basic transaction validation"  // Human-readable description of purpose
    pure: true                                   // PURE FUNCTION: no side effects, deterministic output

    input
        transaction_id: uuid, required           // Unique transaction identifier
        card_number: string, required            // Credit card number
        card_expiry_year: integer, required      // Card expiration year
        card_expiry_month: integer, required     // Card expiration month
        amount: decimal, required                // Transaction amount
        currency: string, required               // Currency code
        merchant_id: string, required            // Merchant identifier
        transaction_time: timestamp, required    // When transaction occurred
    end

    output
        transaction_id: uuid, required           // Pass through transaction ID
        card_number: string, required            // Pass through card number
        amount: decimal, required                // Pass through amount
        currency: string, required               // Pass through currency
        merchant_id: string, required            // Pass through merchant ID
        transaction_time: timestamp, required    // Pass through timestamp
        is_valid: boolean, required              // Validation result flag
        validation_errors: list<string>, required // List of validation error messages
    end

    validate_input                               // PRE-CONDITIONS: checks before processing begins
        amount > 0: "Amount must be positive"                    // Reject if amount is zero or negative
        card_number is not null: "Card number required"          // Reject if card number missing
        merchant_id is not null: "Merchant ID required"          // Reject if merchant ID missing
    end                                          // End of input validation block

    apply                                        // TRANSFORMATION LOGIC: map input to output fields
        transaction_id = transaction_id          // Pass through: copy transaction ID unchanged
        card_number = card_number                // Pass through: copy card number unchanged
        amount = amount                          // Pass through: copy amount unchanged
        currency = currency                      // Pass through: copy currency unchanged
        merchant_id = merchant_id                // Pass through: copy merchant ID unchanged
        transaction_time = transaction_time      // Pass through: copy timestamp unchanged

        // Check card expiry - compute if card is expired
        current_year = year(now())               // LOCAL VAR: get current year from system time
        current_month = month(now())             // LOCAL VAR: get current month from system time
        is_expired = card_expiry_year < current_year or
            (card_expiry_year = current_year and card_expiry_month < current_month)

        // Build validation result - combine expiry check and amount limit
        is_valid = not is_expired and amount <= 10000  // Valid only if not expired AND amount under $10k
        errors_list = when is_expired: "Card expired"
            when amount > 10000: "Amount exceeds limit"
            otherwise: ""
        validation_errors = errors_list
    end                                          // End of apply block

    on_error                                     // ERROR HANDLER: what to do if transform fails
        action: reject                           // Reject the record
        error_code: "VALIDATION_FAILED"          // Error code for tracking
        log_level: error                         // Log at error level
    end                                          // End of error handler
end                                              // End of validate_basic transform

// ----------------------------------------------------------------------------
// TRANSFORM: mask_card_number
// PURPOSE: Mask card number for secure logging (show only last 4 digits)
// INPUT: string (full card number)
// OUTPUT: string (masked card number like ****-****-****-1234)
// ----------------------------------------------------------------------------
transform mask_card_number                       // Declare transform for card masking
    version: 1.0.0                               // Transform version
    description: "Mask card number for logging"  // Purpose description
    pure: true                                   // Pure function: no side effects

    input
        card_number: string, required            // The full card number to mask
    end

    output
        masked_card: string, required            // The masked card number
    end

    apply                                        // Transformation logic
        masked_card = concat("****-****-****-", substring(card_number, 12, 4))  // Mask with last 4 digits
    end                                          // End apply block
end                                              // End of mask_card_number transform
