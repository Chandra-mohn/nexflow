// Fraud Detection Rules - L4 Rules Example
// Demonstrates decision tables and procedural rules

decision_table fraud_check
    hit_policy first_match
    description "Primary fraud detection logic"

    given:
        amount: money
        risk_tier: text
        velocity_24h: number
        account_age: number
        fraud_probability: number

    decide:
        | priority | amount     | risk_tier | velocity_24h | fraud_probability | action     |
        |==========================================================================================|
        | 1        | > 50000    | "high"    | *            | *                 | "block"    |
        | 2        | > 25000    | "high"    | > 10         | *                 | "block"    |
        | 3        | > 10000    | *         | > 20         | *                 | "review"   |
        | 4        | *          | "high"    | *            | > 0.8             | "block"    |
        | 5        | *          | "medium"  | *            | > 0.7             | "review"   |
        | 6        | > 5000     | *         | *            | > 0.6             | "review"   |
        | 7        | < 100      | "low"     | < 5          | < 0.3             | "approve"  |
        | 8        | *          | *         | *            | *                 | "manual"   |

    return:
        action: text
end

decision_table velocity_alert
    hit_policy multi_hit
    description "Velocity-based alert generation"

    given:
        velocity_1h: number
        velocity_24h: number
        avg_amount: money
        current_amount: money

    decide:
        | velocity_1h | velocity_24h | current_amount | alert_type       |
        |====================================================================|
        | > 10        | *            | *              | "high_frequency" |
        | *           | > 50         | *              | "daily_limit"    |
        | *           | *            | > 5000         | "unusual_amount" |
        | > 5         | > 30         | > 3000         | "combined_risk"  |

    return:
        alerts: text
end

decision_table credit_score_tier
    hit_policy first_match
    description "Credit score to risk tier mapping with ranges"

    given:
        credit_score: number

    decide:
        | credit_score   | risk_tier |
        |=============================|
        | 750 to 850     | "low"     |
        | 700 to 749     | "medium"  |
        | 650 to 699     | "elevated"|
        | 600 to 649     | "high"    |
        | < 600          | "critical"|

    return:
        risk_tier: text
end

rule calculate_dynamic_limit:
    if base_limit > 0 and account_age >= 0 and credit_score >= 300 and credit_score <= 850 then
        if account_age < 30 then
            apply_age_multiplier(0.5)
        elseif account_age < 90 then
            apply_age_multiplier(0.75)
        elseif account_age < 365 then
            apply_age_multiplier(0.9)
        else
            apply_age_multiplier(1.0)
        endif

        if credit_score >= 750 then
            apply_credit_multiplier(1.25)
        elseif credit_score >= 700 then
            apply_credit_multiplier(1.1)
        elseif credit_score >= 650 then
            apply_credit_multiplier(1.0)
        elseif credit_score >= 600 then
            apply_credit_multiplier(0.8)
        else
            apply_credit_multiplier(0.5)
        endif

        if fraud_history == 0 then
            apply_fraud_penalty(1.0)
        elseif fraud_history == 1 then
            apply_fraud_penalty(0.7)
        elseif fraud_history <= 3 then
            apply_fraud_penalty(0.4)
        else
            apply_fraud_penalty(0.1)
        endif

        if current_velocity > 20 then
            apply_velocity_factor(0.6)
        elseif current_velocity > 10 then
            apply_velocity_factor(0.8)
        else
            apply_velocity_factor(1.0)
        endif

        calculate_final_limit()
    endif
    return
end

rule categorize_merchant:
    if merchant_id is not null then
        extract_mcc(merchant_id)

        if mcc in ("5411", "5412", "5499") then
            set_category("grocery")
        elseif mcc in ("5812", "5813", "5814") then
            set_category("restaurant")
        elseif mcc in ("5541", "5542") then
            set_category("gas_station")
        elseif mcc in ("5311", "5331", "5399") then
            set_category("retail")
        elseif mcc in ("4111", "4112", "4121") then
            set_category("transportation")
        elseif mcc in ("7011", "7012") then
            set_category("lodging")
        elseif mcc in ("4511", "4582") then
            set_category("airline")
        else
            set_category("other")
        endif

        if category == "other" and avg_transaction > 500 then
            set_risk("high")
        elseif transaction_count < 10 and avg_transaction > 1000 then
            set_risk("high")
        elseif category in ("grocery", "gas_station") then
            set_risk("low")
        else
            set_risk("medium")
        endif
    endif
    return
end
